{% extends "travelpad/base.html" %}
{% load staticfiles %}
{% block head %}
		<title>TravelPad - Itinerary List</title>
		<style>
			.pac-container {
				z-index:1050 !important;
			}
			.itinerary {
				padding-top:70px;
			}
			.thumbnail {
				width:600px;
			}
			.dialogthumbnail {
				width:400px;
			}
			.info {
				vertical-align: top;
			}
		</style>
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=false&language=en"></script>
		{{ itinerary_form.media }}
{% endblock %}

{% block nav %}
{% include "travelpad/nav.html" with itineraries_active='class="active"' %}
{% endblock %}

{% block content %}
	<div class="row come-in">
				    <!-- <h1 class="text-center">Responsive Bootstrap Card-UI with Animation</h1> --> 
		<div class="jumbotron">
			<h1>Welcome to Travelpad!</h1>
			<p>Start Your Journey Here.</p>
			<a role="button" class="btn btn-primary" id="addItineraryButton" type="button" value="Create Itinerary" onclick="addItinerary()"><span class="glyphicon glyphicon-plus-sign"></span> Create Itinerary</a>
		</div>
		<div class="col-md-4">
			{% for itinerary in itineraries %}
			{% if forloop.counter|add:"2"|divisibleby:"3" %}
			
			<div class="panel">
				<div class="panel-body" style="padding:0;">
					<!-- <h2>{{itinerary.title}}</h2>	 -->
					<div class="media">
						<div class="">
							<a href="{% url 'itinerary' itinerary.id %}">
					    	<img class="media-object" src="{% url 'get_itinerary_photo' itinerary.id %}" alt="{{itinerary.title}}" class="img-rounded" width="100%" height="100%" style="border-top-left-radius: 4px; border-top-right-radius: 4px;">
					  		</a>
						</div>
					  	<div class="media-body">
					    	<h2 class="media-heading" style="padding-left:15px;padding-right:15px;">
								<span class="clearfix">
								<div class="dropdown pull-right">
								  <a role="button" class="btn dropdown-toggle glyphicon glyphicon-option-horizontal" type="button"  data-toggle="dropdown" aria-expanded="true"></a>
								  <ul class="dropdown-menu" role="menu" aria-labelledby="" >
									  <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:editItinerary({{itinerary.id}});">Edit Itinerary</a></li>
								  	  <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:deleteItinerary({{itinerary.id}});">Delete</a></li>
								  </ul>
								</div>
								</span>
								<a href="{% url 'itinerary' itinerary.id %}">{{itinerary.title}}</a>
							</h2>
							<h5 style="padding-left:15px;padding-right:15px;"><span class="glyphicon glyphicon-map-marker"><span> {{itinerary.place_name}}</h5>
							<h5 style="padding-left:15px;padding-right:15px;"><span class="glyphicon glyphicon-calendar"><span> {{itinerary.start_date}}&#8213;{{itinerary.end_date}}</h5>
							<hr/>
							<p style="padding-left:15px;padding-right:15px;">{{itinerary.description}}</p>
					  	</div>
					</div>			
				</div>
			</div>
			{% endif %}
			{% endfor %}
		</div>
		
		<div class="col-md-4">
			{% for itinerary in itineraries %}
			{% if forloop.counter|add:"1"|divisibleby:"3" %}
			<div class="panel">
				<div class="panel-body" style="padding:0;">
					<!-- <h2>{{itinerary.title}}</h2>	 -->
					<div class="media">
						<div class="">
							<a href="{% url 'itinerary' itinerary.id %}">
					    	<img class="media-object" src="{% url 'get_itinerary_photo' itinerary.id %}" alt="{{itinerary.title}}" class="img-rounded" width="100%" height="100%" style="border-top-left-radius: 4px; border-top-right-radius: 4px;">
					  		</a>
						</div>
					  	<div class="media-body">
					    	<h2 class="media-heading" style="padding-left:15px;padding-right:15px;">
								<span class="clearfix">
								<div class="dropdown pull-right">
								  <a role="button" class="btn dropdown-toggle glyphicon glyphicon-option-horizontal" type="button"  data-toggle="dropdown" aria-expanded="true"></a>
								  <ul class="dropdown-menu" role="menu" aria-labelledby="" >
									  <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:editItinerary({{itinerary.id}});">Edit Itinerary</a></li>
								  	  <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:deleteItinerary({{itinerary.id}});">Delete</a></li>
								  </ul>
								</div>
								</span>
								<a href="{% url 'itinerary' itinerary.id %}">{{itinerary.title}}</a>
							</h2>
							<h5 style="padding-left:15px;padding-right:15px;"><span class="glyphicon glyphicon-map-marker"><span> {{itinerary.place.name}}</h5>
							<h5 style="padding-left:15px;padding-right:15px;"><span class="glyphicon glyphicon-calendar"><span> {{itinerary.start_date}}&#8213;{{itinerary.end_date}}</h5>
							<hr/>
							<p style="padding-left:15px;padding-right:15px;">{{itinerary.description}}</p>
					  	</div>
					</div>			
				</div>
			</div>
			{% endif %}
			{% endfor %}
		</div>
		
		<div class="col-md-4">
			{% for itinerary in itineraries %}
			{% if forloop.counter|divisibleby:"3" %}
			<div class="panel">
				<div class="panel-body" style="padding:0;">
					<!-- <h2>{{itinerary.title}}</h2>	 -->
					<div class="media">
						<div class="">
							<a href="{% url 'itinerary' itinerary.id %}">
					    	<img class="media-object" src="{% url 'get_itinerary_photo' itinerary.id %}" alt="{{itinerary.title}}" class="img-rounded" width="100%" height="100%" style="border-top-left-radius: 4px; border-top-right-radius: 4px;">
					  		</a>
						</div>
					  	<div class="media-body">
					    	<h2 class="media-heading" style="padding-left:15px;padding-right:15px;">
								<span class="clearfix">
								<div class="dropdown pull-right">
								  <a role="button" class="btn dropdown-toggle glyphicon glyphicon-option-horizontal" type="button"  data-toggle="dropdown" aria-expanded="true"></a>
								  <ul class="dropdown-menu" role="menu" aria-labelledby="" >
									  <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:editItinerary({{itinerary.id}});">Edit Itinerary</a></li>
								  	  <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:deleteItinerary({{itinerary.id}});">Delete</a></li>
								  </ul>
								</div>
								</span>
								<a href="{% url 'itinerary' itinerary.id %}">{{itinerary.title}}</a>
							</h2>
							<h5 style="padding-left:15px;padding-right:15px;"><span class="glyphicon glyphicon-map-marker"><span> {{itinerary.place.name}}</h5>
							<h5 style="padding-left:15px;padding-right:15px;"><span class="glyphicon glyphicon-calendar"><span> {{itinerary.start_date}}&#8213;{{itinerary.end_date}}</h5>
							<hr/>
							<p style="padding-left:15px;padding-right:15px;">{{itinerary.description}}</p>
					  	</div>
					</div>			
				</div>
			</div>
			{% endif %}
			{% endfor %}
		</div>
	</div> <!--end of row -->


		<!-- <div class="row row-offcanvas row-offcanvas-right">
			<div class="col-xs-12 col-lg-12">
				<div class="jumbotron">
					<h1>Welcome to TravelPad!</h1>
					<h2>Your collaborative platform for planning itinerary with friends</h2>
					<p>Here is the gallery of all the itineraries belonging to you!<br>
					You could enter each itinerary for detail by just clicking the image any time, and you could come back to this collection by clicking the "Itinerary" button on the navigation bar above. By pressing the "Update" button, you could update the main properties of each itinerary. Moreover, you could click the button belowed to create a new itinerary belonging to you easily. Enjoy!</p>
					<input class="btn btn-info" id="addItineraryButton" type="button" value="Create an itinerary" onclick="addItinerary()" />
				</div>
				
				<div class="row">
					{% for itinerary in itineraries %}
					<div class="col-xs-6 col-lg-4">
						<a href="{% url 'itinerary' itinerary.id %}">
						<img src="{% url 'get_itinerary_photo' itinerary.id %}" class="img-thumbnail" />
						</a>
						<input style="float:right;" class="btn btn-info" id="editItineraryButton" type="button" value="Update" onclick="editItinerary({{itinerary.id}})" />
						<h2>{{itinerary.title}}</h2>
						<p>{{itinerary.description}}</p>
					</div>
				{% if forloop.counter|divisibleby:3 %}
				</div> 
				<hr class="featurette-divider">
				<div class="row">
				{% endif %}
					{% endfor %}
				</div>
			</div>
		</div>-->

		<div class="modal fade" id="itineraryModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel"></h4>
					</div>
					<div class="modal-body">
						<form id="itineraryForm" enctype="multipart/form-data" action="{% url 'update_itinerary' %}" method="POST">
							<input type="hidden" id="existed_id" />
							{% for hidden in itinerary_form.hidden_fields %}
							{{ hidden }}
							{% endfor %}								
							<table>
								{% for field in itinerary_form.visible_fields %}
								<tr>
									<td><label class="inputlabel" for="{{ field.name }}">{{ field.label }}:
									{% if field.field.required %}
										*
									{% endif %}
									</label></td>
									<td>
										{% if field.label == "Photo" %}
										<img class="img-thumbnail" id="modalImg" src="{% url 'get_itinerary_photo' %}/0"  alt="Not uploaded yet" />
										<input name="clear" type="checkbox">Clear</input>
										{% endif %}
										{{field}}
									</td>
									<td>
									{% for error in field.errors %}
										<p class="errorlabel" for="{{ error }}">{{ error }}</p>
									{% endfor %}
									</td>
								</tr>
								{% endfor %}
								<tr>
									<td><label class="inputlabel" for="id_location">Location:
										*
									</label></td>
									<td>
										<input id="id_location" type="text" class='form-control' placeholder: 'the main location in this itinerary' />
									</td>
								</tr>
							</table>
							{% csrf_token %}
						</form>
					</div>
					<div class="modal-footer">
						<form id="deleteItineraryForm" action="{% url 'delete_itinerary' %}" method="POST">
							<input type="hidden" id="delete_id" name="id" />
							{% csrf_token %}
						</form>
						<input type="button" id="modalDeleteButton" class="btn btn-danger" value="Delete" onclick="$('#deleteItineraryForm').submit();"></input>
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button id="modalButton" type="button" class="btn btn-primary" onclick="$('#itineraryForm').submit();">Save changes</button>
					</div>
				</div>
			</div>
		</div>

{% endblock %}


{% block tail %}
	<script>
		function addItinerary() {
			$('#itineraryForm').attr("action", "{% url 'update_itinerary' %}/0");
			$('#modalImg').attr("src", "{% url 'get_itinerary_photo' %}/0");
			$('#id_title').val("");
			$('#id_description').val("");
			$('#id_location').val("");
			$('#id_place_id').val("");
			$('#id_place_name').val("");
			$('#id_place_lat').val("");
			$('#id_place_lng').val("");
			$('#id_start_date').val("");
			$('#id_end_date').val("");
			$('#id_participants').val("");
			$('#myModalLabel').text("Add Itinerary");
			$('#modalButton').text("Create Itinerary");
			$('#modalDeleteButton').hide();
			$('#itineraryModal').modal('show');
		}
		function editItinerary(id) {
			$.ajax( {
				url: "{% url 'get_itineraryform_json' %}/" + id,
				type: "GET",
				dataType: "text json",
				success: function(data, status) {
					$('#itineraryForm').attr("action", "{% url 'update_itinerary' %}/" + id);
					$('#modalImg').attr("src", "{% url 'get_itinerary_photo' %}/" + id);
					var itinerary = data[0].fields;
					$('#id_title').val(itinerary.title);
					$('#id_description').val(itinerary.description);
					$('#id_location').val(itinerary.location);
					$('#id_place_id').val(itinerary.place_id);
					$('#id_location').val(itinerary.place_name);
					$('#id_place_name').val(itinerary.place_name);
					$('#id_place_lat').val(itinerary.place_lat);
					$('#id_place_lng').val(itinerary.place_lng);
					$('#id_start_date').val(itinerary.start_date);
					$('#id_end_date').val(itinerary.end_date);
					$('#id_participants').val(itinerary.participants);
					$('#myModalLabel').text("Update Itinerary");
					$('#modalButton').text("Save Change");
					$('#modalDeleteButton').click( function() {
						$.ajax( {
							url: "{% url 'delete_itinerary' %}",
							type: "POST",
							data: {"id": id}
						});
					});
					$('#delete_id').val(id);
					$('#modalDeleteButton').show();
					$('#itineraryModal').modal('show');
				}
			});
		}
		function deleteItinerary(id) {
			if (confirm("Please think twice. Are you sure you want to delete this itinerary?") == false)
				return;
			$('#delete_id').val(id);
			$('#deleteItineraryForm').submit();
		}
		function readURL(input) {
			if (input.files && input.files[0]) {
				var reader = new FileReader();

				reader.onload = function (e) {
					$('#modalImg').attr('src', e.target.result);
				}

				reader.readAsDataURL(input.files[0]);
			}
		}
		
		$("#id_photo").change(function(){
			readURL(this);
		});

		$(document).ready(function(){
			{% for error in errors %}
			$.toaster({ priority : 'danger', title : 'Error', message : "{{error}}" });
			{% endfor %}
			
			var input = (document.getElementById('id_location'));
			var options = { types: ['(cities)'] };
			var autocomplete = new google.maps.places.Autocomplete(input, options);
			var place = autocomplete.getPlace();
			google.maps.event.addListener(autocomplete, 'place_changed', function() {
				var place = autocomplete.getPlace();
				if (!place.geometry) {
					return;
				}
				$("#id_place_id").val(place.place_id)
				$("#id_place_lat").val(place.geometry.location.lat())
				$("#id_place_lng").val(place.geometry.location.lng())
				$("#id_place_name").val(place.name)
			});
		});
		
	</script>
{% endblock %}

